<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Гадание на звездах</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            margin: 0;
            font-family: sans-serif;
            background-color: rgb(237 129 124);
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: background-color 0.5s ease;
        }

        .container {
            position: relative;
            width: 100%;
            height: 100%;
        }

        .star {
            position: absolute;
            background-size: contain;
            background-repeat: no-repeat;
            cursor: pointer;
            transition:  opacity 0.3s ease;
            opacity: 0.9;
            width: 50px;
            height: 50px;
            z-index: 1;
            -webkit-tap-highlight-color: transparent;
        }

        .star.background-star {
            opacity: 0.4;
        }

        .star.darkened-selected {
            opacity: 0.4;
        }

        .instruction {
            background-color: transparent;
            padding: 15px 25px;
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: center;
            border: 2px solid #ffd700;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 1.2em;
            font-weight: bold;
            white-space: nowrap;
            z-index: 2;
        }

        .instruction-hidden { display: none; }

        .card-container {
            display: flex;
            justify-content: space-around;
            width: 80%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            opacity: 0;
            transition: opacity 0.5s ease;
            z-index: 2;
        }

        .card-container.visible { opacity: 1; }

        .card {
           /* Set the fixed dimensions - REDUCED SIZE */
            width: 80px; /* Reduced from 100px */
            height: 140.53px; /* Reduced from 175.67px, maintaining aspect ratio */
            border: 4px solid #f5f5dc; /* Beige border */
            border-radius: 8px;
            margin: 0 7px; /* Reduced margin */
            cursor: pointer;
            position: relative;
            background-size: cover; /* This is VERY important to make the image fill the fixed size */
            background-position: center; /* Center the image within the fixed size */
            z-index: 2;
        }

        .next-button {
           background-color: #ffeb3b;
            color: #333; /* Dark gray color */
            padding: 12px 45px; /* Increased padding for a bigger button */
            border-radius: 15px;
            border: none;
            cursor: pointer;
            font-size: 20px; /* Increased font-size for a bigger text */
            margin-top: 20px;
            display: none;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            bottom: 23%;
            z-index: 2;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            font-weight: bold; /* Make the text bold */
        }

        .card-title {
            text-align: center;
            font-size: 1.5em;
            color: #ffd700;
            position: absolute;
            top: 180px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 2;
            font-weight: bold; /* Make the text bold */
        }

        .card-title-hidden { display: none; }

        .temporary-card {
            position: absolute;
            width: 70px; /* Reduced from 100px */
            height: 123px; /* Reduced from 175.67px, maintaining aspect ratio */
            border: 4px solid #f5f5dc; /* Beige border */
            border-radius: 8px;
            background-size: cover;
            background-position: center;
            z-index: 3;
            transition: transform 6s ease, opacity 0.5s ease; /* Changed to 4 seconds */
        }

        body.dark-mode {
            background-color: #444; /* Darker background color */
            transition: background-color 4s ease; /* Added transition for background color */
        }

        .card-title.card-title-visible,
        .next-button.next-button-visible {
            opacity: 1;
            transition: opacity 2s ease 2s; /* Fade in after 2 seconds, over 2 seconds */
        }
    </style>
</head>
<body>
<div class="container">
    <div class="instruction">Думай о своем вопросе <br> и выбери <span style="color: #ffd700;"><span id="starsToChoose"></span> </span>звезды</div>
    <div class="card-title card-title-hidden">Твои карты:</div>
    <div class="card-container"></div>
    <button class="next-button">Далее ></button>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    // Variable to control the number of stars to choose and cards to show
    const numberOfChoices = 3; // You can change this value
    let selectedStars = 0;
    const totalStars = 15;
    const stars = [];
    let selectedCardFilenames = [];

    const container = document.querySelector('.container');
    const instruction = document.querySelector('.instruction');
    const cardContainer = document.querySelector('.card-container');
    const nextButton = document.querySelector('.next-button');
    const cardTitle = document.querySelector('.card-title');
    const body = document.querySelector('body');
    const starsToChooseSpan = document.getElementById('starsToChoose');

    // Use raw URLs for the two initial star images
    const initialStarFiles = [
        "https://raw.githubusercontent.com/Vasiliy-katsyka/stars/5f6e5f0e7d869bc594d813ad68ccbf16d2c1e3cd/Vector2.svg",
        "https://raw.githubusercontent.com/Vasiliy-katsyka/stars/5f6e5f0e7d869bc594d813ad68ccbf16d2c1e3cd/Vector.svg"
    ];

    const selectedStarMap = {
        "https://raw.githubusercontent.com/Vasiliy-katsyka/stars/5f6e5f0e7d869bc594d813ad68ccbf16d2c1e3cd/Vector.svg": "https://raw.githubusercontent.com/Vasiliy-katsyka/stars/5f6e5f0e7d869bc594d813ad68ccbf16d2c1e3cd/Vecto3r.svg",
        "https://raw.githubusercontent.com/Vasiliy-katsyka/stars/5f6e5f0e7d869bc594d813ad68ccbf16d2c1e3cd/Vector2.svg": "https://raw.githubusercontent.com/Vasiliy-katsyka/stars/5f6e5f0e7d869bc594d813ad68ccbf16d2c1e3cd/Vector4.svg"
    };


    function preloadImages(imageUrls) {
        imageUrls.forEach(url => {
            const img = new Image();
            img.src = url;
        });
    }

    preloadImages(initialStarFiles); // Preload the initial star images


   function selectStar(event) {
        const star = event.currentTarget;
        if (!cardContainer.classList.contains('visible') && !star.classList.contains('selected') && selectedStars < numberOfChoices) {
            const currentBackgroundImage = star.style.backgroundImage.slice(5, -2); // Extract URL from backgroundImage
            let selectedStarFile = selectedStarMap[currentBackgroundImage];

            if (selectedStarFile) {
                star.style.backgroundImage = `url(${selectedStarFile})`;
            } else {
                // Handle case where the initial image doesn't have a specific selected state
                console.warn("No selected image defined for:", currentBackgroundImage);
                 return;
             }

            star.classList.add('selected');
            selectedStars++;

             if (selectedStars === numberOfChoices) {
               showTemporaryCards();
             }
        }
    }


   function createStars() {
        const containerRect = container.getBoundingClientRect();
        const instructionRect = instruction.getBoundingClientRect();

        for (let i = 0; i < totalStars; i++) {
            const star = document.createElement('div');
            star.classList.add('star');
            const size = Math.floor(Math.random() * 21) + 40;
            star.style.width = `${size}px`;
            star.style.height = `${size}px`;

            // Use only the two initial star files
            const randomStarFile = initialStarFiles[Math.floor(Math.random() * initialStarFiles.length)];
            star.style.backgroundImage = `url(${randomStarFile})`;  // No need to encode, already raw URLs


            let left, top, attempts = 0;
            do {
                left = Math.random() * (containerRect.width - size);
                top = Math.random() * (containerRect.height - size);
                attempts++;
            } while (attempts < 100 && (isOverlapping(star, left, top, size) || isInsideInstruction(left, top, size, instructionRect)));

            star.style.left = `${left}px`;
            star.style.top = `${top}px`;
            star.addEventListener('click', selectStar);
            container.appendChild(star);
            stars.push(star);
        }
    }


    function isOverlapping(newStar, left, top, size) {
        for (const existingStar of stars) {
            const existingRect = existingStar.getBoundingClientRect();
             if (left < existingRect.right && left + size > existingRect.left &&
                top < existingRect.bottom && top + size > existingRect.top) return true;
        }
        return false;
    }

    function isInsideInstruction(left, top, size, instructionRect) {
      const starRect = { left, top, right: left + size, bottom: top + size };
      return starRect.left < instructionRect.right && starRect.right > instructionRect.left &&
             starRect.top < instructionRect.bottom && starRect.bottom > instructionRect.top;
    }

     function createCards() {
        const cards = [];
        const repoBaseUrl = "https://raw.githubusercontent.com/Vasiliy-katsyka/stars/main/Cards-png%202/Cards-png/";
        const cardFiles = [
            "╨С╨░╤И╨╜╤П.png",
            "╨Т╨╗╤О╨▒╨╗╨╡╨╜╨╜╤Л╨╡.png",
            "╨Т╨╛╤Б╤М╨╝╨╡╤А╨║╨░ ╨Ц╨╡╨╖╨╗╨╛╨▓.png",
            "╨Т╨╛╤Б╤М╨╝╨╡╤А╨║╨░ ╨Ъ╤Г╨▒╨║╨╛╨▓.png",
            "╨Т╨╛╤Б╤М╨╝╨╡╤А╨║╨░ ╨Ь╨╡╤З╨╡╨╕╠Ж.png",
            "╨Т╨╛╤Б╤М╨╝╨╡╤А╨║╨░ ╨Я╨╡╨╜╤В╨░╨║╨╗╨╡╨╕╠Ж.png",
            "╨Т╨╡╤А╤Е╨╛╨▓╨╜╨░╤П ╨Ц╤А╨╕╤Ж╨░.png",
            "╨Ф╤М╤П╨▓╨╛╨╗.png",
            "╨Ф╨╡╤Б╤П╤В╨║╨░ ╨Ц╨╡╨╖╨╗╨╛╨▓.png",
            "╨Ф╨╡╤Б╤П╤В╨║╨░ ╨Ъ╤Г╨▒╨║╨╛╨▓.png",
            "╨Ф╨╡╤Б╤П╤В╨║╨░ ╨Ь╨╡╤З╨╡╨╕╠Ж.png",
            "╨Ф╨╡╤Б╤П╤В╨║╨░ ╨Я╨╡╨╜╤В╨░╨║╨╗╨╡╨╕╠Ж.png",
            "╨Ф╨╡╨▓╤П╤В╨║╨░ ╨Ц╨╡╨╖╨╗╨╛╨▓.png",
            "╨Ф╨╡╨▓╤П╤В╨║╨░ ╨Ъ╤Г╨▒╨║╨╛╨▓.png",
            "╨Ф╨╡╨▓╤П╤В╨║╨░ ╨Ь╨╡╤З╨╡╨╕╠Ж.png",
            "╨Ф╨╡╨▓╤П╤В╨║╨░ ╨Я╨╡╨╜╤В╨░╨║╨╗╨╡╨╕╠Ж.png",
            "╨Ф╨▓╨╛╨╕╠Ж╨║╨░ ╨Ц╨╡╨╖╨╗╨╛╨▓.png",
            "╨Ф╨▓╨╛╨╕╠Ж╨║╨░ ╨Ъ╤Г╨▒╨║╨╛╨▓.png",
            "╨Ф╨▓╨╛╨╕╠Ж╨║╨░ ╨Ь╨╡╤З╨╡╨╕╠Ж.png",
            "╨Ф╨▓╨╛╨╕╠Ж╨║╨░ ╨Я╨╡╨╜╤В╨░╨║╨╗╨╡╨╕╠Ж.png",
            "╨Ч╨▓╨╡╨╖╨┤╨░.png",
            "╨Ш╨╝╨┐╨╡╤А╨░╤В╤А╨╕╤Ж╨░.png",
            "╨Ш╨╝╨┐╨╡╤А╨░╤В╨╛╤А.png",
            "╨Ш╨╡╤А╨╛╤Д╨░╨╜╤В.png",
            "╨Ъ╨╛╤А╨╛╨╗╤М ╨Ц╨╡╨╖╨╗╨╛╨▓.png",
            "╨Ъ╨╛╤А╨╛╨╗╤М ╨Ъ╤Г╨▒╨║╨╛╨▓.png",
            "╨Ъ╨╛╤А╨╛╨╗╤М ╨Ь╨╡╤З╨╡╨╕╠Ж.png",
            "╨Ъ╨╛╤А╨╛╨╗╤М ╨Я╨╡╨╜╤В╨░╨║╨╗╨╡╨╕╠Ж.png",
            "╨Ъ╨╛╤А╨╛╨╗╨╡╨▓╨░ ╨Ц╨╡╨╖╨╗╨╛╨▓.png",
            "╨Ъ╨╛╤А╨╛╨╗╨╡╨▓╨░ ╨Ъ╤Г╨▒╨║╨╛╨▓.png",
            "╨Ъ╨╛╤А╨╛╨╗╨╡╨▓╨░ ╨Ь╨╡╤З╨╡╨╕╠Ж.png",
            "╨Ъ╨╛╤А╨╛╨╗╨╡╨▓╨░ ╨Я╨╡╨╜╤В╨░╨║╨╗╨╡╨╕╠Ж.png",
            "╨Ъ╨╛╨╗╨╡╤Б╨╛ ╨д╨╛╤А╤В╤Г╨╜╤Л.png",
            "╨Ъ╨╛╨╗╨╡╤Б╨╜╨╕╤Ж╨░.png",
            "╨Ы╤Г╨╜╨░.png",
            "╨Ь╨╕╤А.png",
            "╨Ь╨░╨│.png",
            "╨Ю╤В╤И╨╡╨╗╤М╨╜╨╕╨║.png",
            "╨Я╤П╤В╨╡╤А╨║╨░ ╨Ц╨╡╨╖╨╗╨╛╨▓.png",
            "╨Я╤П╤В╨╡╤А╨║╨░ ╨Ъ╤Г╨▒╨║╨╛╨▓.png",
            "╨Я╤П╤В╨╡╤А╨║╨░ ╨Ь╨╡╤З╨╡╨╕╠Ж.png",
            "╨Я╤П╤В╨╡╤А╨║╨░ ╨Я╨╡╨╜╤В╨░╨║╨╗╨╡╨╕╠Ж.png",
            "╨Я╨╛╨▓╨╡╤И╨╡╨╜╨╜╤Л╨╕╠Ж.png",
            "╨Я╨░╨╢ ╨Ц╨╡╨╖╨╗╨╛╨▓.png",
            "╨Я╨░╨╢ ╨Ъ╤Г╨▒╨║╨╛╨▓.png",
            "╨Я╨░╨╢ ╨Ь╨╡╤З╨╡╨╕╠Ж.png",
            "╨Я╨░╨╢ ╨Я╨╡╨╜╤В╨░╨║╨╗╨╡╨╕╠Ж.png",
            "╨а╤Л╤Ж╨░╤А╤М ╨Ц╨╡╨╖╨╗╨╛╨▓.png",
            "╨а╤Л╤Ж╨░╤А╤М ╨Ъ╤Г╨▒╨║╨╛╨▓.png",
            "╨а╤Л╤Ж╨░╤А╤М ╨Ь╨╡╤З╨╡╨╕╠Ж.png",
            "╨а╤Л╤Ж╨░╤А╤М ╨Я╨╡╨╜╤В╨░╨║╨╗╨╡╨╕╠Ж.png",
            "╨б╤Г╨┤.png",
            "╨б╨┐╤А╨░╨▓╨╡╨┤╨╗╨╕╨▓╨╛╤Б╤В╤М.png",
            "╨б╨╕╨╗╨░.png",
            "╨б╨╛╨╗╨╜╤Ж╨╡.png",
            "╨б╨╝╨╡╤А╤В╤М.png",
            "╨б╨╡╨╝╨╡╤А╨║╨░ ╨Ц╨╡╨╖╨╗╨╛╨▓.png",
            "╨б╨╡╨╝╨╡╤А╨║╨░ ╨Ъ╤Г╨▒╨║╨╛╨▓.png",
            "╨б╨╡╨╝╨╡╤А╨║╨░ ╨Ь╨╡╤З╨╡╨╕╠Ж.png",
            "╨б╨╡╨╝╨╡╤А╨║╨░ ╨Я╨╡╨╜╤В╨░╨║╨╗╨╡╨╕╠Ж.png",
            "╨в╤А╨╛╨╕╠Ж╨║╨░ ╨Ц╨╡╨╖╨╗╨╛╨▓.png",
            "╨в╤А╨╛╨╕╠Ж╨║╨░ ╨Ъ╤Г╨▒╨║╨╛╨▓.png",
            "╨в╤А╨╛╨╕╠Ж╨║╨░ ╨Ь╨╡╤З╨╡╨╕╠Ж.png",
            "╨в╤А╨╛╨╕╠Ж╨║╨░ ╨Я╨╡╨╜╤В╨░╨║╨╗╨╡╨╕╠Ж.png",
            "╨в╤Г╨╖ ╨Ц╨╡╨╖╨╗╨╛╨▓.png",
            "╨в╤Г╨╖ ╨Ъ╤Г╨▒╨║╨╛╨▓.png",
            "╨в╤Г╨╖ ╨Ь╨╡╤З╨╡╨╕╠Ж.png",
            "╨в╤Г╨╖ ╨Я╨╡╨╜╤В╨░╨║╨╗╨╡╨╕╠Ж.png",
            "╨г╨╝╨╡╤А╨╡╨╜╨╜╨╛╤Б╤В╤М.png",
            "╨з╨╡╤В╨▓╨╡╤А╨║╨░ ╨Ц╨╡╨╖╨╗╨╛╨▓.png",
            "╨з╨╡╤В╨▓╨╡╤А╨║╨░ ╨Ъ╤Г╨▒╨║╨╛╨▓.png",
            "╨з╨╡╤В╨▓╨╡╤А╨║╨░ ╨Ь╨╡╤З╨╡╨╕╠Ж.png",
            "╨з╨╡╤В╨▓╨╡╤А╨║╨░ ╨Я╨╡╨╜╤В╨░╨║╨╗╨╡╨╕╠Ж.png",
            "╨и╤Г╤В.png",
            "╨и╨╡╤Б╤В╨╡╤А╨║╨░ ╨Ц╨╡╨╖╨╗╨╛╨▓.png",
            "╨и╨╡╤Б╤В╨╡╤А╨║╨░ ╨Ъ╤Г╨▒╨║╨╛╨▓.png",
            "╨и╨╡╤Б╤В╨╡╤А╨║╨░ ╨Ь╨╡╤З╨╡╨╕╠Ж.png",
            "╨и╨╡╤Б╤В╨╡╤А╨║╨░ ╨Я╨╡╨╜╤В╨░╨║╨╗╨╡╨╕╠Ж.png"
            ];

        selectedCardFilenames = [];
        let availableFiles = [...cardFiles];

        for (let i = 0; i < numberOfChoices; i++) {
            if (availableFiles.length === 0) break;
            const randomIndex = Math.floor(Math.random() * availableFiles.length);
            selectedCardFilenames.push(availableFiles[randomIndex]);
            availableFiles.splice(randomIndex, 1);
        }
        return selectedCardFilenames;
    }



   function showTemporaryCards() {
       const filenames = createCards();

        stars.filter(star => star.classList.contains('selected')).forEach((star, index) => {
            const starRect = star.getBoundingClientRect();
            const containerRect = container.getBoundingClientRect();

            const tempCard = document.createElement('div');
            tempCard.classList.add('temporary-card');
            const encodedFilename = encodeURIComponent(filenames[index]);

            const repoBaseUrl = "https://raw.githubusercontent.com/Vasiliy-katsyka/stars/main/Cards-png%202/Cards-png/";
            tempCard.style.backgroundImage = `url(${repoBaseUrl + encodedFilename})`;

            tempCard.style.left = `${starRect.left - containerRect.left}px`;
            tempCard.style.top = `${starRect.top - containerRect.top}px`;
            container.appendChild(tempCard);


            // Store a reference to the card
            star.tempCard = tempCard;
        });

        setTimeout(() => {
            body.classList.add('dark-mode');
             showCards();
        }, 50);  // Short delay to allow DOM updates
    }


   function showCards() {
       const filenames = selectedCardFilenames;
        instruction.classList.add('instruction-hidden');
         //add to show temporary card
         stars.filter(star => star.classList.contains('selected')).forEach((star, index) => {
            const tempCard = document.createElement('div');
            tempCard.classList.add('card');
            const encodedFilename = encodeURIComponent(filenames[index]);
            const repoBaseUrl = "https://raw.githubusercontent.com/Vasiliy-katsyka/stars/main/Cards-png%202/Cards-png/";

            tempCard.style.backgroundImage = `url(${repoBaseUrl + encodedFilename})`;
            cardContainer.appendChild(tempCard);
        });


        setTimeout(() => {
            document.body.style.backgroundColor = '#704747';
            cardTitle.classList.remove('card-title-hidden');
            nextButton.classList.add('next-button-visible');
            cardTitle.classList.add('card-title-visible');

            stars.forEach(star => {
                star.classList.add('background-star');
                if (star.classList.contains('selected')) {
                    star.classList.add('darkened-selected');
                     // Hide or remove the temporary card
                    if (star.tempCard) {
                        star.tempCard.style.opacity = '0';
                        setTimeout(() => {
                            star.tempCard.remove();
                        }, 500); // Wait for transition
                    }
                }
                star.style.cursor = 'default';
                star.removeEventListener('click', selectStar);
            });

            cardContainer.classList.add('visible');
            nextButton.style.display = 'block';
            nextButton.addEventListener('click', () => {
                sendCardData();
                onNextButtonClick();
            });
        }, 2000)
    }



    function sendCardData() {
        tg.sendData(JSON.stringify(selectedCardFilenames));
        tg.close();
    }

    function onNextButtonClick() {
        selectedStars = 0;
        document.body.style.backgroundColor = 'rgb(237 129 124)';
        cardTitle.classList.add('card-title-hidden');
        nextButton.classList.remove('next-button-visible');
        cardTitle.classList.remove('card-title-visible');
        instruction.classList.remove('instruction-hidden');
        stars.forEach(star => {
            star.classList.remove('background-star', 'selected', 'darkened-selected');
            // Reset to initial star images
             const randomStarFile = initialStarFiles[Math.floor(Math.random() * initialStarFiles.length)];
             star.style.backgroundImage = `url(${randomStarFile})`;

            star.style.cursor = 'pointer';
            star.addEventListener('click', selectStar);
             if (star.tempCard) {
                star.tempCard.remove();
                star.tempCard = null;
            }
        });
        cardContainer.innerHTML = '';
        cardContainer.classList.remove('visible');
        nextButton.style.display = 'none';
        stars.length = 0;
        container.querySelectorAll('.star').forEach(star => container.removeChild(star));
        selectedCardFilenames = [];
        createStars();
        body.classList.remove('dark-mode');
    }

    // Initialize the number of stars to choose in the instruction
    starsToChooseSpan.textContent = numberOfChoices;
    createStars();
</script>
</body>
</html>
